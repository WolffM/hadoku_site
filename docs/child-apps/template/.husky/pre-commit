#!/bin/sh
echo "ğŸ” Running pre-commit checks..."

# Capture originally staged files BEFORE any modifications
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Auto-fix linting and formatting issues
echo "ğŸ“‹ Running ESLint auto-fix..."
pnpm run lint:fix
if [ $? -ne 0 ]; then
  echo "âŒ ESLint found errors that could not be auto-fixed."
  echo "ğŸ’¡ Please fix the errors manually before committing."
  exit 1
fi

echo "âœ¨ Auto-formatting code..."
pnpm run format

echo "âœ… Linting and formatting complete!"

# Bump version if src/, package.json, or build config changed
echo "ğŸ“¦ Checking if version bump is needed..."

if git diff --cached --name-only | grep -q -E "^(src/|package\.json|vite\.config\.|tsconfig\.)"; then
  echo "ğŸ”„ Code or build config changes detected, bumping version..."

# Read current version from package.json
current_version=$(node -p "require('./package.json').version")
major=$(echo $current_version | cut -d. -f1)
minor=$(echo $current_version | cut -d. -f2)
patch=$(echo $current_version | cut -d. -f3)

# Rollover at .20 to keep patch numbers manageable
if [ $patch -eq 20 ]; then
  new_minor=$((minor + 1))
  new_version="$major.$new_minor.0"
  echo "ğŸš€ Rolling over to minor version"
else
  new_patch=$((patch + 1))
  new_version="$major.$minor.$new_patch"
  echo "ğŸ“ˆ Incrementing patch version"
fi

# Update package.json with new version
node -e "
const fs = require('fs');
const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
pkg.version = '$new_version';
fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
"

echo "âœ… Version bumped: $current_version â†’ $new_version"

  # Update lock file
  pnpm install --lockfile-only

  # Stage the version changes
  git add package.json pnpm-lock.yaml
else
  echo "â„¹ï¸  No code changes detected, skipping version bump"
fi

# Re-stage only the files that were originally staged (after lint/format may have modified them)
# This avoids accidentally staging unrelated working directory changes
if [ -n "$STAGED_FILES" ]; then
  echo "$STAGED_FILES" | xargs -r git add
fi

echo "âœ… All pre-commit checks passed!"
