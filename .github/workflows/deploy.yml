name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  repository_dispatch:
    types: [watchparty_updated, task_updated, contact_updated, herodraft_updated]

permissions:
  contents: read
  pages: write
  id-token: write
  actions: read  # Need this to download artifacts from other repos

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Download watchparty artifact
        if: github.event.action == 'watchparty_updated'
        env:
          GITHUB_TOKEN: ${{ secrets.HADOKU_SITE_TOKEN }}
        run: |
          set -euo pipefail
          temp_dir="$(mktemp -d)"
          trap 'rm -rf "$temp_dir"' EXIT

          echo "Downloading watchparty build from run ${{ github.event.client_payload.run_id }}"
          
          # Get artifacts list using GitHub API
          ARTIFACTS_URL="https://api.github.com/repos/WolffM/hadoku-watchparty/actions/runs/${{ github.event.client_payload.run_id }}/artifacts"
          echo "Fetching artifacts from: $ARTIFACTS_URL"
          
          ARTIFACTS_JSON=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
                                -H "Accept: application/vnd.github+json" \
                                -H "X-GitHub-Api-Version: 2022-11-28" \
                                "$ARTIFACTS_URL")
          
          # Extract artifact download URL for 'watchparty-dist'
          DOWNLOAD_URL=$(echo "$ARTIFACTS_JSON" | jq -r '.artifacts[] | select(.name=="watchparty-dist") | .archive_download_url')
          
          if [ "$DOWNLOAD_URL" = "null" ] || [ -z "$DOWNLOAD_URL" ]; then
            echo "❌ watchparty-dist artifact not found"
            echo "Available artifacts:"
            echo "$ARTIFACTS_JSON" | jq -r '.artifacts[].name'
            exit 1
          fi
          
          echo "Found artifact download URL: $DOWNLOAD_URL"
          
          # Download and extract artifact
          curl -s -L -H "Authorization: Bearer $GITHUB_TOKEN" \
               "$DOWNLOAD_URL" -o "$temp_dir/watchparty-dist.zip"
          
          unzip -qo "$temp_dir/watchparty-dist.zip" -d "$temp_dir/extracted"
          
          # Find the content directory using the same logic as the remote version
          contents_dir=""
          search_roots=("$temp_dir/extracted")
          
          for root in "${search_roots[@]}"; do
            candidate="$(find "$root" -mindepth 1 -maxdepth 4 -type f \
              \( -name 'index.html' -o -name 'index.js' \) -print -quit)"
            if [ -n "$candidate" ]; then
              contents_dir="$(dirname "$candidate")"
              break
            fi
          done

          if [ -z "$contents_dir" ] || [ ! -d "$contents_dir" ]; then
            echo "Downloaded artifact contents:"
            find "$temp_dir" -maxdepth 4 -print
            echo "❌ Failed to locate downloaded watchparty artifacts"
            exit 1
          fi

          rm -rf ./public/mf/watchparty
          mkdir -p ./public/mf/watchparty
          shopt -s dotglob
          cp -a "$contents_dir"/* ./public/mf/watchparty/
          shopt -u dotglob

          echo "✓ Downloaded watchparty artifacts"
          ls -la ./public/mf/watchparty
      
      - name: Download task artifact
        if: github.event.action == 'task_updated'
        env:
          GITHUB_TOKEN: ${{ secrets.HADOKU_SITE_TOKEN }}
        run: |
          set -euo pipefail
          temp_dir="$(mktemp -d)"
          trap 'rm -rf "$temp_dir"' EXIT

          echo "Downloading task build from run ${{ github.event.client_payload.run_id }}"
          
          # Get artifacts list using GitHub API
          ARTIFACTS_URL="https://api.github.com/repos/WolffM/hadoku-task/actions/runs/${{ github.event.client_payload.run_id }}/artifacts"
          echo "Fetching artifacts from: $ARTIFACTS_URL"
          
          ARTIFACTS_JSON=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
                                -H "Accept: application/vnd.github+json" \
                                -H "X-GitHub-Api-Version: 2022-11-28" \
                                "$ARTIFACTS_URL")
          
          # Extract artifact download URL for 'task-dist'
          DOWNLOAD_URL=$(echo "$ARTIFACTS_JSON" | jq -r '.artifacts[] | select(.name=="task-dist") | .archive_download_url')
          
          if [ "$DOWNLOAD_URL" = "null" ] || [ -z "$DOWNLOAD_URL" ]; then
            echo "❌ task-dist artifact not found"
            echo "Available artifacts:"
            echo "$ARTIFACTS_JSON" | jq -r '.artifacts[].name'
            exit 1
          fi
          
          echo "Found artifact download URL: $DOWNLOAD_URL"
          
          # Download and extract artifact
          curl -s -L -H "Authorization: Bearer $GITHUB_TOKEN" \
               "$DOWNLOAD_URL" -o "$temp_dir/task-dist.zip"
          
          unzip -qo "$temp_dir/task-dist.zip" -d "$temp_dir/extracted"
          
          # Find the content directory using the same logic as the remote version
          contents_dir=""
          search_roots=("$temp_dir/extracted")
          
          for root in "${search_roots[@]}"; do
            candidate="$(find "$root" -mindepth 1 -maxdepth 4 -type f \
              \( -name 'index.html' -o -name 'index.js' \) -print -quit)"
            if [ -n "$candidate" ]; then
              contents_dir="$(dirname "$candidate")"
              break
            fi
          done

          if [ -z "$contents_dir" ] || [ ! -d "$contents_dir" ]; then
            echo "Downloaded artifact contents:"
            find "$temp_dir" -maxdepth 4 -print
            echo "❌ Failed to locate downloaded task artifacts"
            exit 1
          fi

          rm -rf ./public/mf/task
          mkdir -p ./public/mf/task
          shopt -s dotglob
          cp -a "$contents_dir"/* ./public/mf/task/
          shopt -u dotglob

          echo "✓ Downloaded task artifacts"
          ls -la ./public/mf/task
      
      - name: Download contact artifact
        if: github.event.action == 'contact_updated'
        env:
          GITHUB_TOKEN: ${{ secrets.HADOKU_SITE_TOKEN }}
        run: |
          echo "Downloading contact build from run ${{ github.event.client_payload.run_id }}"
          
          # Get artifacts list using GitHub API
          ARTIFACTS_URL="https://api.github.com/repos/WolffM/hadoku-contact/actions/runs/${{ github.event.client_payload.run_id }}/artifacts"
          echo "Fetching artifacts from: $ARTIFACTS_URL"
          
          ARTIFACTS_JSON=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
                                -H "Accept: application/vnd.github+json" \
                                -H "X-GitHub-Api-Version: 2022-11-28" \
                                "$ARTIFACTS_URL")
          
          # Extract artifact download URL for 'contact-dist'
          DOWNLOAD_URL=$(echo "$ARTIFACTS_JSON" | jq -r '.artifacts[] | select(.name=="contact-dist") | .archive_download_url')
          
          if [ "$DOWNLOAD_URL" = "null" ] || [ -z "$DOWNLOAD_URL" ]; then
            echo "❌ contact-dist artifact not found"
            echo "Available artifacts:"
            echo "$ARTIFACTS_JSON" | jq -r '.artifacts[].name'
            exit 1
          fi
          
          echo "Found artifact download URL: $DOWNLOAD_URL"
          
          # Download and extract artifact
          mkdir -p ./public/mf/contact
          curl -s -L -H "Authorization: Bearer $GITHUB_TOKEN" \
               "$DOWNLOAD_URL" -o contact-dist.zip
          
          unzip -o contact-dist.zip -d temp-contact
          
          # Handle nested directory structure
          if [ -d "temp-contact/contact-dist" ]; then
            cp -r temp-contact/contact-dist/* ./public/mf/contact/
          else
            cp -r temp-contact/* ./public/mf/contact/
          fi
          
          rm -rf temp-contact contact-dist.zip
          echo "✓ Downloaded contact artifacts"
          ls -la ./public/mf/contact
      
      - name: Download herodraft artifact
        if: github.event.action == 'herodraft_updated'
        env:
          GITHUB_TOKEN: ${{ secrets.HADOKU_SITE_TOKEN }}
        run: |
          echo "Downloading herodraft build from run ${{ github.event.client_payload.run_id }}"
          
          # Get artifacts list using GitHub API
          ARTIFACTS_URL="https://api.github.com/repos/WolffM/hadoku-herodraft/actions/runs/${{ github.event.client_payload.run_id }}/artifacts"
          echo "Fetching artifacts from: $ARTIFACTS_URL"
          
          ARTIFACTS_JSON=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
                                -H "Accept: application/vnd.github+json" \
                                -H "X-GitHub-Api-Version: 2022-11-28" \
                                "$ARTIFACTS_URL")
          
          # Extract artifact download URL for 'herodraft-dist'
          DOWNLOAD_URL=$(echo "$ARTIFACTS_JSON" | jq -r '.artifacts[] | select(.name=="herodraft-dist") | .archive_download_url')
          
          if [ "$DOWNLOAD_URL" = "null" ] || [ -z "$DOWNLOAD_URL" ]; then
            echo "❌ herodraft-dist artifact not found"
            echo "Available artifacts:"
            echo "$ARTIFACTS_JSON" | jq -r '.artifacts[].name'
            exit 1
          fi
          
          echo "Found artifact download URL: $DOWNLOAD_URL"
          
          # Download and extract artifact
          mkdir -p ./public/mf/herodraft
          curl -s -L -H "Authorization: Bearer $GITHUB_TOKEN" \
               "$DOWNLOAD_URL" -o herodraft-dist.zip
          
          unzip -o herodraft-dist.zip -d temp-herodraft
          
          # Handle nested directory structure
          if [ -d "temp-herodraft/herodraft-dist" ]; then
            cp -r temp-herodraft/herodraft-dist/* ./public/mf/herodraft/
          else
            cp -r temp-herodraft/* ./public/mf/herodraft/
          fi
          
          rm -rf temp-herodraft herodraft-dist.zip
          echo "✓ Downloaded herodraft artifacts"
          ls -la ./public/mf/herodraft
      
      - name: Install dependencies
        run: npm ci
      
      - name: Debug environment variables
        env:
          PUBLIC_ADMIN_KEY: ${{ secrets.ADMIN_KEY }}
          PUBLIC_FRIEND_KEY: ${{ secrets.FRIEND_KEY }}
        run: |
          echo "PUBLIC_ADMIN_KEY set? ${PUBLIC_ADMIN_KEY:+yes}"
          echo "PUBLIC_FRIEND_KEY set? ${PUBLIC_FRIEND_KEY:+yes}"
          if [ -z "$PUBLIC_ADMIN_KEY" ] || [ -z "$PUBLIC_FRIEND_KEY" ]; then
            echo "❌ Missing required secrets (ADMIN_KEY or FRIEND_KEY)."
            exit 1
          fi

      - name: Build with Astro
        env:
          HADOKU_SITE_TOKEN: ${{ secrets.HADOKU_SITE_TOKEN }}
          PUBLIC_ADMIN_KEY: ${{ secrets.ADMIN_KEY }}
          PUBLIC_FRIEND_KEY: ${{ secrets.FRIEND_KEY }}
          MODE: production
        run: npm run build
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
